<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N빵 백엔드 테스트 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .form-label {
            font-weight: 500;
        }
        #receipt-items-table .form-check-input {
            cursor: pointer;
        }
        .log {
            background-color: #212529;
            color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4 text-center">N빵 백엔드 테스트 페이지</h1>

        <!-- 1. Group Management -->
        <div class="card">
            <div class="card-header">
                <h3>1. 그룹 관리</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>그룹 생성</h5>
                        <div class="input-group mb-3">
                            <input type="text" id="group-name-input" class="form-control" placeholder="새 그룹 이름">
                            <button class="btn btn-primary" onclick="handleCreateGroup()">그룹 생성</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>그룹 선택</h5>
                        <div class="input-group mb-3">
                            <select id="group-select" class="form-select" onchange="handleSelectGroup()"></select>
                            <button class="btn btn-secondary" onclick="fetchAllGroups()">그룹 새로고침</button>
                        </div>
                    </div>
                </div>
                <div id="group-details-card" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">그룹 정보</h5>
                        <p><strong>ID:</strong> <span id="group-id-display"></span></p>
                        <p><strong>이름:</strong> <span id="group-name-display"></span></p>
                        <h6>멤버:</h6>
                        <ul id="group-members-list" class="list-group mb-3"></ul>
                        <h5>멤버 추가</h5>
                        <div class="input-group">
                            <input type="text" id="member-name-input" class="form-control" placeholder="새 멤버 이름">
                            <button class="btn btn-outline-primary" onclick="handleAddMember()">멤버 추가</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Settlement Management -->
        <div class="card">
            <div class="card-header">
                <h3>2. 정산 관리</h3>
            </div>
            <div class="card-body">
                <h5>정산 생성</h5>
                <div class="input-group mb-3">
                    <input type="text" id="settlement-name-input" class="form-control" placeholder="새 정산 이름">
                    <button class="btn btn-primary" onclick="handleCreateSettlement()">정산 생성</button>
                </div>
                <h5>정산 선택</h5>
                 <div class="input-group mb-3">
                    <select id="settlement-select" class="form-select" onchange="handleSelectSettlement()"></select>
                </div>
                <div id="settlement-details-card" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">정산 정보</h5>
                        <p><strong>ID:</strong> <span id="settlement-id-display"></span></p>
                        <p><strong>이름:</strong> <span id="settlement-name-display"></span></p>
                        <p><strong>총 금액:</strong> <span id="settlement-total-display"></span></p>
                        <h6>영수증 목록:</h6>
                        <ul id="settlement-receipts-list" class="list-group"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Add Receipt -->
        <div class="card">
            <div class="card-header">
                <h3>3. 영수증 추가</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="receipt-file-input" class="form-label">OCR 영수증 업로드</label>
                    <div class="input-group">
                        <input type="file" class="form-control" id="receipt-file-input">
                        <button class="btn btn-secondary" onclick="handleOcr()">OCR로 분석</button>
                    </div>
                </div>
                <hr>
                <h5>영수증 상세정보</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="payer-select" class="form-label">결제자</label>
                        <select id="payer-select" class="form-select"></select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="store-name-input" class="form-label">가게 이름</label>
                        <input type="text" id="store-name-input" class="form-control">
                    </div>
                     <div class="col-md-6 mb-3">
                        <label for="total-amount-input" class="form-label">총 금액</label>
                        <input type="number" id="total-amount-input" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="transaction-date-input" class="form-label">거래 날짜</label>
                        <input type="text" id="transaction-date-input" class="form-control" placeholder="YYYY-MM-DD">
                    </div>
                </div>
                
                <h5 class="mt-3">영수증 항목</h5>
                <table id="receipt-items-table" class="table">
                    <thead>
                        <tr>
                            <th>항목 이름</th>
                            <th>가격</th>
                            <th>참여자 (<a href="#" onclick="event.preventDefault(); toggleAllParticipants(true)">전체</a> / <a href="#" onclick="event.preventDefault(); toggleAllParticipants(false)">해제</a>)</th>
                            <th>동작</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic rows will be inserted here -->
                    </tbody>
                </table>
                <button class="btn btn-outline-secondary" onclick="addReceiptItemRow()">+ 항목 추가</button>
                <hr>
                <button class="btn btn-success w-100" onclick="handleSubmitReceipt()">정산에 영수증 제출</button>
            </div>
        </div>

        <!-- 4. Calculation -->
        <div class="card">
            <div class="card-header">
                <h3>4. 정산 계산</h3>
            </div>
            <div class="card-body">
                <button class="btn btn-info w-100 mb-3" onclick="handleCalculate()">정산 계산하기</button>
                <div id="calculation-result-card" class="d-none">
                    <h5>사용자별 잔액</h5>
                    <table class="table">
                        <thead>
                            <tr><th>사용자 ID</th><th>잔액</th><th>상태</th></tr>
                        </thead>
                        <tbody id="balances-table-body"></tbody>
                    </table>
                    <h5 class="mt-4">추천 송금 목록</h5>
                    <table class="table">
                        <thead>
                            <tr><th>보내는 사람</th><th>받는 사람</th><th>금액</th></tr>
                        </thead>
                        <tbody id="transactions-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Log -->
        <div class="card">
            <div class="card-header">
                로그
            </div>
            <div class="card-body">
                <div id="log-container" class="log"></div>
            </div>
        </div>
    </div>

<script>
// --- STATE MANAGEMENT ---
const state = {
    groups: [],
    selectedGroupId: null,
    selectedGroup: null,
    settlements: [],
    selectedSettlementId: null,
    selectedSettlement: null,
};

const API_BASE_URL = "/api/v1";

// --- LOGGING ---
function log(message, data) {
    const logContainer = document.getElementById('log-container');
    const time = new Date().toLocaleTimeString();
    let content = `[${time}] ${message}`;
    if (data) {
        content += `
${JSON.stringify(data, null, 2)}`;
    }
    logContainer.innerHTML = content + '

' + logContainer.innerHTML;
}

// --- API HELPERS ---
async function apiRequest(endpoint, method = 'GET', body = null) {
    const options = {
        method,
        headers: { 'Content-Type': 'application/json' },
    };
    if (body) {
        options.body = JSON.stringify(body);
    }
    log(`요청: ${method} ${endpoint}`, body);
    try {
        const response = await fetch(API_BASE_URL + endpoint, options);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP 오류! 상태: ${response.status}, 메시지: ${errorText}`);
        }
        const responseData = response.status === 204 || response.headers.get('content-length') === '0' ? null : await response.json();
        log(`응답: ${method} ${endpoint} (성공)`, responseData);
        return responseData;
    } catch (error) {
        log(`응답: ${method} ${endpoint} (오류)`, { error: error.message });
        alert(`API 오류: ${error.message}`);
        throw error;
    }
}

// --- UI RENDERING ---
function renderGroupOptions() {
    const select = document.getElementById('group-select');
    select.innerHTML = '<option selected disabled>그룹을 선택하세요</option>';
    state.groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = `${group.name} (ID: ${group.id})`;
        select.appendChild(option);
    });
}

function renderGroupDetails() {
    if (!state.selectedGroup) {
        document.getElementById('group-details-card').classList.add('d-none');
        return;
    }
    document.getElementById('group-id-display').textContent = state.selectedGroup.id;
    document.getElementById('group-name-display').textContent = state.selectedGroup.name;
    
    const membersList = document.getElementById('group-members-list');
    membersList.innerHTML = '';
    const members = state.selectedGroup.members || {};
    Object.keys(members).forEach(memberId => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = memberId; // In a real app, you'd fetch user names
        membersList.appendChild(li);
    });

    renderPayerOptions();
    document.getElementById('group-details-card').classList.remove('d-none');
}

function renderPayerOptions() {
    const select = document.getElementById('payer-select');
    select.innerHTML = '<option selected disabled>결제자를 선택하세요</option>';
    if (!state.selectedGroup || !state.selectedGroup.members) return;
    Object.keys(state.selectedGroup.members).forEach(memberId => {
        const option = document.createElement('option');
        option.value = memberId;
        option.textContent = memberId;
        select.appendChild(option);
    });
}

function renderSettlementOptions() {
    const select = document.getElementById('settlement-select');
    select.innerHTML = '<option selected disabled>정산을 선택하세요</option>';
    state.settlements.forEach(settlement => {
        const option = document.createElement('option');
        option.value = settlement.id;
        option.textContent = `${settlement.name} (ID: ${settlement.id})`;
        select.appendChild(option);
    });
}

function renderSettlementDetails() {
     if (!state.selectedSettlement) {
        document.getElementById('settlement-details-card').classList.add('d-none');
        return;
    }
    document.getElementById('settlement-id-display').textContent = state.selectedSettlement.settlementId;
    document.getElementById('settlement-name-display').textContent = state.selectedSettlement.settlementName;
    document.getElementById('settlement-total-display').textContent = state.selectedSettlement.totalAmount;

    const receiptsList = document.getElementById('settlement-receipts-list');
    receiptsList.innerHTML = '';
    (state.selectedSettlement.receipts || []).forEach(receipt => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `영수증 ID: ${receipt.id}, 가게: ${receipt.storeName}, 금액: ${receipt.totalAmount}, 결제자: ${receipt.payerId}`;
        receiptsList.appendChild(li);
    });
    document.getElementById('settlement-details-card').classList.remove('d-none');
}

function addReceiptItemRow(item = { name: '', price: 0, participants: [] }) {
    const tbody = document.getElementById('receipt-items-table').getElementsByTagName('tbody')[0];
    const newRow = tbody.insertRow();

    const nameCell = newRow.insertCell();
    nameCell.innerHTML = `<input type="text" class="form-control item-name" value="${item.name}">`;

    const priceCell = newRow.insertCell();
    priceCell.innerHTML = `<input type="number" class="form-control item-price" value="${item.price}">`;

    const participantsCell = newRow.insertCell();
    const members = state.selectedGroup?.members ? Object.keys(state.selectedGroup.members) : [];
    let checkboxes = members.map(memberId => `
        <div class="form-check form-check-inline">
            <input class="form-check-input item-participant" type="checkbox" value="${memberId}" ${item.participants.includes(memberId) ? 'checked' : ''}>
            <label class="form-check-label">${memberId}</label>
        </div>
    `).join('');
    participantsCell.innerHTML = checkboxes;

    const actionCell = newRow.insertCell();
    actionCell.innerHTML = `<button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">삭제</button>`;
}

function toggleAllParticipants(checked) {
    document.querySelectorAll('.item-participant').forEach(cb => cb.checked = checked);
}

function renderCalculationResults(result) {
    document.getElementById('calculation-result-card').classList.remove('d-none');
    
    const balancesBody = document.getElementById('balances-table-body');
    balancesBody.innerHTML = '';
    for (const [userId, balance] of Object.entries(result.userBalances)) {
        const row = balancesBody.insertRow();
        row.insertCell().textContent = userId;
        row.insertCell().textContent = balance.toFixed(2);
        const status = balance > 0.01 ? '받을 돈' : (balance < -0.01 ? '낼 돈' : '정산 완료');
        row.insertCell().textContent = status;
    }

    const transactionsBody = document.getElementById('transactions-table-body');
    transactionsBody.innerHTML = '';
    (result.transactions || []).forEach(tx => {
        const row = transactionsBody.insertRow();
        row.insertCell().textContent = tx.fromUser;
        row.insertCell().textContent = tx.toUser;
        row.insertCell().textContent = tx.amount.toFixed(2);
    });
}

// --- EVENT HANDLERS ---
async function handleCreateGroup() {
    const groupName = document.getElementById('group-name-input').value;
    if (!groupName) {
        alert('그룹 이름을 입력하세요.');
        return;
    }
    await apiRequest('/groups', 'POST', { name: groupName }); // DTO field is 'name'
    await fetchAllGroups();
}

async function fetchAllGroups() {
    state.groups = await apiRequest('/groups');
    renderGroupOptions();
}

async function handleSelectGroup() {
    state.selectedGroupId = document.getElementById('group-select').value;
    if (!state.selectedGroupId) return;
    state.selectedGroup = await apiRequest(`/groups/${state.selectedGroupId}`);
    
    // Mock: The backend doesn't return settlements for a group, so we clear it
    state.settlements = [];
    state.selectedSettlementId = null;
    state.selectedSettlement = null;
    renderSettlementOptions();
    renderSettlementDetails();
    
    renderGroupDetails();
}

async function handleAddMember() {
    const memberName = document.getElementById('member-name-input').value;
    if (!memberName || !state.selectedGroupId) {
        alert('그룹을 선택하고 멤버 이름을 입력하세요.');
        return;
    }
    await apiRequest(`/groups/${state.selectedGroupId}/members`, 'POST', { userName: memberName });
    // Refresh group details
    state.selectedGroup = await apiRequest(`/groups/${state.selectedGroupId}`);
    renderGroupDetails();
}

async function handleCreateSettlement() {
    const settlementName = document.getElementById('settlement-name-input').value;
    if (!settlementName || !state.selectedGroupId) {
        alert('그룹을 선택하고 정산 이름을 입력하세요.');
        return;
    }
    const newSettlement = await apiRequest('/settlements', 'POST', { settlementName, groupId: state.selectedGroupId });
    // Mock: We don't have a get-settlements-by-group endpoint, so we add it manually
    state.settlements.push({ id: newSettlement.settlementId, name: newSettlement.settlementName });
    renderSettlementOptions();
}

async function handleSelectSettlement() {
    state.selectedSettlementId = document.getElementById('settlement-select').value;
    if (!state.selectedSettlementId) return;
    state.selectedSettlement = await apiRequest(`/settlements/${state.selectedSettlementId}`);
    renderSettlementDetails();
}

async function handleOcr() {
    const fileInput = document.getElementById('receipt-file-input');
    if (fileInput.files.length === 0) {
        alert('파일을 선택하세요.');
        return;
    }
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    log('요청: POST /ocr/parse');
    try {
        const response = await fetch(API_BASE_URL + '/ocr/parse', { method: 'POST', body: formData });
        if (!response.ok) throw new Error(`HTTP 오류! 상태: ${response.status}`);
        const result = await response.json();
        log('응답: POST /ocr/parse (성공)', result);

        // Populate the form
        document.getElementById('store-name-input').value = result.storeName || '';
        document.getElementById('transaction-date-input').value = result.transactionDate || '';
        document.getElementById('total-amount-input').value = result.totalAmount || 0;
        
        const itemsTbody = document.getElementById('receipt-items-table').getElementsByTagName('tbody')[0];
        itemsTbody.innerHTML = ''; // Clear existing items
        (result.items || []).forEach(item => addReceiptItemRow(item));

    } catch (error) {
        log('응답: POST /ocr/parse (오류)', { error: error.message });
        alert(`OCR 오류: ${error.message}`);
    }
}

async function handleSubmitReceipt() {
    if (!state.selectedSettlementId) {
        alert('먼저 정산을 선택하세요.');
        return;
    }

    const items = [];
    const itemRows = document.getElementById('receipt-items-table').getElementsByTagName('tbody')[0].rows;
    for (const row of itemRows) {
        const name = row.querySelector('.item-name').value;
        const price = parseFloat(row.querySelector('.item-price').value);
        const participants = Array.from(row.querySelectorAll('.item-participant:checked')).map(cb => cb.value);
        if (!name || isNaN(price) || price <= 0) {
            alert('모든 항목에 유효한 이름과 가격을 입력했는지 확인하세요.');
            return;
        }
        items.push({ name, price, participants });
    }

    const receiptRequest = {
        payerId: document.getElementById('payer-select').value,
        storeName: document.getElementById('store-name-input').value,
        transactionDate: document.getElementById('transaction-date-input').value,
        totalAmount: parseFloat(document.getElementById('total-amount-input').value),
        items: items,
    };

    if (!receiptRequest.payerId) {
        alert('결제자를 선택하세요.');
        return;
    }

    await apiRequest(`/settlements/${state.selectedSettlementId}/receipts`, 'POST', receiptRequest);
    
    // Refresh settlement details
    state.selectedSettlement = await apiRequest(`/settlements/${state.selectedSettlementId}`);
    renderSettlementDetails();
}

async function handleCalculate() {
    if (!state.selectedSettlementId) {
        alert('계산할 정산을 선택하세요.');
        return;
    }
    const result = await apiRequest(`/settlements/${state.selectedSettlementId}/calculate`, 'POST');
    renderCalculationResults(result);
}


// --- INITIALIZATION ---
window.onload = () => {
    log('테스트 페이지 로드됨.');
    fetchAllGroups();
};
</script>
</body>
</html>