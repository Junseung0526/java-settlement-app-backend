<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Nppang-Backend Test Page</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1, h2 { border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        fieldset { border: 1px solid #ccc; border-radius: 5px; padding: 1em; margin-bottom: 1em; }
        legend { font-weight: bold; font-size: 1.2em; }
        label { display: inline-block; width: 120px; margin-bottom: 0.5em; }
        input[type="text"], input[type="number"] { width: 200px; padding: 5px; }
        button { padding: 8px 15px; border-radius: 4px; border: none; background-color: #007bff; color: white; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #response { white-space: pre-wrap; background-color: #f4f4f4; border: 1px solid #ddd; padding: 1em; margin-top: 1em; min-height: 50px; }
        .api-section { margin-bottom: 1.5em; }
    </style>
</head>
<body>

<h1>Nppang-Backend API Test Page</h1>

<fieldset>
    <legend>1. Group Management</legend>
    <div class="api-section">
        <h3>Create Group</h3>
        <label for="groupName">Group Name:</label>
        <input type="text" id="groupName" value="테스트 그룹">
        <button id="createGroupBtn">Create Group</button>
    </div>
    <div class="api-section">
        <h3>Add Member to Group</h3>
        <label for="addMemberGroupId">Group ID:</label>
        <input type="number" id="addMemberGroupId" placeholder="Group ID">
        <label for="userId">User ID:</label>
        <input type="number" id="userId" value="1">
        <button id="addMemberBtn">Add Member</button>
    </div>
    <div class="api-section">
        <h3>Get All Groups</h3>
        <button id="getAllGroupsBtn">Get Groups</button>
    </div>
    <div class="api-section">
        <h3>Get Group Members</h3>
        <label for="getMembersGroupId">Group ID:</label>
        <input type="number" id="getMembersGroupId" placeholder="Group ID">
        <button id="getMembersBtn">Get Members</button>
    </div>
</fieldset>

<fieldset>
    <legend>2. Settlement Management</legend>
    <div class="api-section">
        <h3>Create Settlement</h3>
        <label for="settlementName">Settlement Name:</label>
        <input type="text" id="settlementName" value="오늘의 저녁 식사">
        <label for="settlementGroupId">Group ID (Optional):</label>
        <input type="number" id="settlementGroupId" placeholder="Group ID for this settlement">
        <button id="createSettlementBtn">Create Settlement</button>
    </div>
    <div class="api-section">
        <h3>Add Receipt to Settlement</h3>
        <label for="receiptSettlementId">Settlement ID:</label>
        <input type="number" id="receiptSettlementId" placeholder="Settlement ID">
        <label for="receiptFile">Receipt Image:</label>
        <input type="file" id="receiptFile" accept="image/*">
        <button id="addReceiptBtn">Add Receipt</button>
    </div>
    <div class="api-section">
        <h3>Get Settlement Details</h3>
        <label for="getSettlementId">Settlement ID:</label>
        <input type="number" id="getSettlementId" placeholder="Settlement ID">
        <button id="getSettlementBtn">Get Settlement</button>
    </div>
</fieldset>

<fieldset>
    <legend>3. Calculation</legend>
    <div class="api-section">
        <h3>Calculate Settlement</h3>
        <label for="calcSettlementId">Settlement ID:</label>
        <input type="number" id="calcSettlementId" placeholder="Settlement ID">
        <label for="calcAlcoholDrinkers">Alcohol Drinkers:</label>
        <input type="number" id="calcAlcoholDrinkers" value="0">
        <button id="calculateBtn">Calculate</button>
    </div>
</fieldset>

<h2>API Response:</h2>
<pre id="response">API results will be shown here.</pre>

<script>
    const responseEl = document.getElementById('response');

    // Helper function for fetch
    async function apiCall(url, options = {}, message) {
        responseEl.textContent = message || 'Processing...';
        try {
            const response = await fetch(url, options);
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'Request failed');
            }
            responseEl.textContent = JSON.stringify(data, null, 2);
            return data;
        } catch (error) {
            responseEl.textContent = `Error: ${error.message}

${error.stack || ''}`;
            console.error(error);
        }
    }

    // 1. Group Management
    document.getElementById('createGroupBtn').onclick = async () => {
        const groupName = document.getElementById('groupName').value;
        const data = await apiCall('/api/v1/groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: groupName })
        }, 'Creating group...');
        if (data) {
            document.getElementById('addMemberGroupId').value = data.id;
            document.getElementById('getMembersGroupId').value = data.id;
            document.getElementById('settlementGroupId').value = data.id;
        }
    };

    document.getElementById('addMemberBtn').onclick = () => {
        const groupId = document.getElementById('addMemberGroupId').value;
        const userId = document.getElementById('userId').value;
        if (!groupId) {
            alert('Please provide a Group ID.');
            return;
        }
        apiCall(`/api/v1/groups/${groupId}/members`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId })
        }, `Adding member to group ${groupId}...`);
    };

    document.getElementById('getAllGroupsBtn').onclick = () => {
        apiCall('/api/v1/groups', {}, 'Fetching all groups...');
    };

    document.getElementById('getMembersBtn').onclick = () => {
        const groupId = document.getElementById('getMembersGroupId').value;
        if (!groupId) {
            alert('Please provide a Group ID.');
            return;
        }
        apiCall(`/api/v1/groups/${groupId}/members`, {}, `Fetching members for group ${groupId}...`);
    };

    // 2. Settlement Management
    document.getElementById('createSettlementBtn').onclick = async () => {
        const settlementName = document.getElementById('settlementName').value;
        const groupId = document.getElementById('settlementGroupId').value;
        const body = { settlementName };
        if (groupId) {
            body.groupId = groupId;
        }
        const data = await apiCall('/api/v1/settlements', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }, 'Creating settlement...');
        if (data) {
            const settlementId = data.settlementId;
            document.getElementById('receiptSettlementId').value = settlementId;
            document.getElementById('getSettlementId').value = settlementId;
            document.getElementById('calcSettlementId').value = settlementId;
        }
    };

    document.getElementById('addReceiptBtn').onclick = () => {
        const settlementId = document.getElementById('receiptSettlementId').value;
        const fileInput = document.getElementById('receiptFile');
        if (!settlementId) {
            alert('Please provide a Settlement ID.');
            return;
        }
        if (fileInput.files.length === 0) {
            alert('Please select a receipt image file.');
            return;
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        apiCall(`/api/v1/settlements/${settlementId}/receipts`, {
            method: 'POST',
            body: formData
        }, `Adding receipt to settlement ${settlementId}...`);
    };

    document.getElementById('getSettlementBtn').onclick = () => {
        const settlementId = document.getElementById('getSettlementId').value;
        if (!settlementId) {
            alert('Please provide a Settlement ID.');
            return;
        }
        apiCall(`/api/v1/settlements/${settlementId}`, {}, `Fetching details for settlement ${settlementId}...`);
    };

    // 3. Calculation
    document.getElementById('calculateBtn').onclick = () => {
        const settlementId = document.getElementById('calcSettlementId').value;
        const alcoholDrinkers = document.getElementById('calcAlcoholDrinkers').value;
        if (!settlementId) {
            alert('Please provide a Settlement ID.');
            return;
        }
        apiCall(`/api/v1/settlements/${settlementId}/calculate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ alcoholDrinkers: parseInt(alcoholDrinkers) })
        }, `Calculating settlement ${settlementId}...`);
    };

</script>

</body>
</html>