<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>N-Pang API 통합 테스트 페이지</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f4f7f6;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            margin-top: 25px;
        }

        .api-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #dcdcdc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .result {
            margin-top: 15px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-left: 5px solid #3498db;
        }

        .endpoint {
            font-style: italic;
            color: #7f8c8d;
        }

        .method {
            font-weight: bold;
            color: #c0392b;
        }

        .get-method {
            color: #27ae60;
        }

        .post-method {
            color: #e67e22;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>N-Pang API 통합 테스트 페이지</h1>

    <p><strong>기본 API 경로:</strong> <code>/api/v1</code></p>
    <p style="color: red;"><strong>주의:</strong> 테스트를 위해서는 백엔드 서버가 실행 중이어야 하며, Group ID와 Settlement ID는 API 호출을 통해 생성된
        유효한 ID를 사용해야 합니다.</p>

    <h2>1. 그룹 관리 (GroupController)</h2>
    <div class="api-section">
        <h3><span class="method post-method">POST</span> /groups (그룹 생성)</h3>
        <label for="createGroupName">그룹 이름:</label>
        <input type="text" id="createGroupName" value="테스트 그룹">
        <button onclick="createGroup()">그룹 생성</button>
        <div id="createGroupResult" class="result">응답 결과:</div>
    </div>

    <div class="api-section">
        <h3><span class="method get-method">GET</span> /groups (모든 그룹 조회)</h3>
        <button onclick="getAllGroups()">모든 그룹 조회</button>
        <div id="getAllGroupsResult" class="result">응답 결과:</div>
    </div>

    <div class="api-section">
        <h3><span class="method get-method">GET</span> /groups/{groupId} (특정 그룹 조회)</h3>
        <label for="getGroupId">Group ID:</label>
        <input type="text" id="getGroupId" value="유효한 Group ID 입력">
        <button onclick="getGroup()">그룹 조회</button>
        <div id="getGroupResult" class="result">응답 결과:</div>
    </div>

    <div class="api-section">
        <h3><span class="method post-method">POST</span> /groups/{groupId}/members (멤버 추가)</h3>
        <label for="addMemberGroupId">Group ID:</label>
        <input type="text" id="addMemberGroupId" value="유효한 Group ID 입력">
        <label for="addMemberUserName">추가할 멤버 User Name:</label>
        <input type="text" id="addMemberUserName" value="testUser1">
        <button onclick="addMember()">멤버 추가</button>
        <div id="addMemberResult" class="result">응답 결과:</div>
    </div>

    <h2>2. 정산 관리 (SettlementController)</h2>
    <div class="api-section">
        <h3><span class="method post-method">POST</span> /settlements (정산 생성)</h3>
        <label for="createSettlementName">정산 이름:</label>
        <input type="text" id="createSettlementName" value="여행 정산">
        <label for="createSettlementGroupId">Group ID:</label>
        <input type="text" id="createSettlementGroupId" value="유효한 Group ID 입력">
        <button onclick="createSettlement()">정산 생성</button>
        <div id="createSettlementResult" class="result">응답 결과:</div>
    </div>

    <div class="api-section">
        <h3><span class="method post-method">POST</span> /settlements/{settlementId}/receipts (영수증 추가)</h3>
        <label for="addReceiptSettlementId">Settlement ID:</label>
        <input type="text" id="addReceiptSettlementId" value="유효한 Settlement ID 입력">
        <label for="addReceiptBody">요청 본문 (JSON):</label>
        <textarea id="addReceiptBody" rows="10">{
  "payerUsername": "user1",
  "storeName": "Starbucks",
  "paymentMethod": "CARD",
  "totalAmount": 15000,
  "receiptItems": [
    {
      "itemName": "Latte",
      "amount": 5000,
      "participants": ["user1", "user2"]
    },
    {
      "itemName": "Sandwich",
      "amount": 10000,
      "participants": ["user1", "user3"]
    }
  ]
}</textarea>
        <button onclick="addReceipt()">영수증 추가</button>
        <div id="addReceiptResult" class="result">응답 결과:</div>
    </div>

    <div class="api-section">
        <h3><span class="method get-method">GET</span> /settlements/{settlementId} (정산 상세 조회)</h3>
        <label for="getSettlementId">Settlement ID:</label>
        <input type="text" id="getSettlementId" value="유효한 Settlement ID 입력">
        <button onclick="getSettlement()">정산 상세 조회</button>
        <div id="getSettlementResult" class="result">응답 결과:</div>
    </div>

    <div class="api-section">
        <h3><span class="method post-method">POST</span> /settlements/{settlementId}/calculate (정산 계산)</h3>
        <label for="calculateSettlementId">Settlement ID:</label>
        <input type="text" id="calculateSettlementId" value="유효한 Settlement ID 입력">
        <button onclick="calculateSettlement()">정산 계산</button>
        <div id="calculateSettlementResult" class="result">응답 결과:</div>
    </div>

    <h2>3. OCR (OcrController)</h2>
    <div class="api-section">
        <h3><span class="method post-method">POST</span> /ocr/parse (영수증 이미지 분석)</h3>
        <form id="ocrForm">
            <label for="ocrFile">영수증 이미지 파일 (RequestParam 'file'):</label>
            <input type="file" id="ocrFile" name="file" accept="image/*" required>
            <button type="submit">OCR 분석 요청</button>
        </form>
        <div id="ocrParseResult" class="result">응답 결과:</div>
    </div>

</div>

<script>
    const API_BASE = '/api/v1';

    // 결과 표시를 위한 공통 함수
    async function displayResult(response, resultElementId) {
        const resultElement = document.getElementById(resultElementId);
        let content = '';

        try {
            if (response.status === 204 || response.headers.get("content-length") === "0") {
                content = `HTTP Status: ${response.status} (No Content)`;
            } else {
                const json = await response.json();
                content = `HTTP Status: ${response.status}\n\n${JSON.stringify(json, null, 2)}`;
            }
        } catch (error) {
            content = `HTTP Status: ${response.status} (Non-JSON Response or Error)\n\n${await response.text()}`;
        }

        resultElement.textContent = `응답 결과:\n${content}`;
    }

    // 그룹 관리 API 함수
    async function createGroup() {
        const name = document.getElementById('createGroupName').value;
        const response = await fetch(`${API_BASE}/groups`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name})
        });
        await displayResult(response, 'createGroupResult');
    }

    async function getAllGroups() {
        const response = await fetch(`${API_BASE}/groups`, {method: 'GET'});
        await displayResult(response, 'getAllGroupsResult');
    }

    async function getGroup() {
        const groupId = document.getElementById('getGroupId').value;
        const response = await fetch(`${API_BASE}/groups/${groupId}`, {method: 'GET'});
        await displayResult(response, 'getGroupResult');
    }

    async function addMember() {
        const groupId = document.getElementById('addMemberGroupId').value;
        const userName = document.getElementById('addMemberUserName').value;
        const response = await fetch(`${API_BASE}/groups/${groupId}/members`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userName: userName})
        });
        await displayResult(response, 'addMemberResult');
    }

    // 정산 관리 API 함수
    async function createSettlement() {
        const settlementName = document.getElementById('createSettlementName').value;
        const groupId = document.getElementById('createSettlementGroupId').value;
        const response = await fetch(`${API_BASE}/settlements`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({settlementName: settlementName, groupId: groupId})
        });
        await displayResult(response, 'createSettlementResult');
    }

    async function addReceipt() {
        const settlementId = document.getElementById('addReceiptSettlementId').value;
        const bodyText = document.getElementById('addReceiptBody').value;

        // JSON 파싱 에러 방지
        let bodyJson;
        try {
            bodyJson = JSON.parse(bodyText);
        } catch (e) {
            document.getElementById('addReceiptResult').textContent = `응답 결과:\nJSON 요청 본문 파싱 에러: ${e.message}`;
            return;
        }

        const response = await fetch(`${API_BASE}/settlements/${settlementId}/receipts`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(bodyJson) // 파싱된 JSON 객체를 문자열로 다시 변환하여 전송
        });
        await displayResult(response, 'addReceiptResult');
    }

    async function getSettlement() {
        const settlementId = document.getElementById('getSettlementId').value;
        const response = await fetch(`${API_BASE}/settlements/${settlementId}`, {method: 'GET'});
        await displayResult(response, 'getSettlementResult');
    }

    async function calculateSettlement() {
        const settlementId = document.getElementById('calculateSettlementId').value;
        const response = await fetch(`${API_BASE}/settlements/${settlementId}/calculate`, {
            method: 'POST',
            // POST 요청이지만 서버에서 요청 본문을 사용하지 않을 수 있으므로 빈 JSON으로 전송
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        await displayResult(response, 'calculateSettlementResult');
    }

    // OCR API 함수 (Form submit으로 처리)
    document.getElementById('ocrForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const fileInput = document.getElementById('ocrFile');

        if (fileInput.files.length === 0) {
            document.getElementById('ocrParseResult').textContent = '응답 결과:\n파일을 선택해주세요.';
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        // MultipartFile 요청이므로 Content-Type을 설정하지 않음 (fetch가 자동으로 multipart/form-data를 설정)
        const response = await fetch(`${API_BASE}/ocr/parse`, {
            method: 'POST',
            body: formData
        });

        await displayResult(response, 'ocrParseResult');
    });

</script>
</body>
</html>
